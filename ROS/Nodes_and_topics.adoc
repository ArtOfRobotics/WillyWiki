include::../Header.adoc[]

== ROS node and topic implementation of Willy

=== Overview
In this document the ROS node and topic implementation of Willy is described. Willy is built around ROS (www.ros.org). It is presumed that the reader has average knowledge of ROS.

ROS is setup with the ROS master running on Willy. Every node connects to the ROS master so that the nodes are aware of each other and can communicate to each other. The nodes of Willy are located within two environments and can be divided in three categories.

The two possible locations are:

*	Willy: run on the robot Willy himself
*	Skylab: the private cloud environment for Willy at Windesheim

The three node categories are:

*	Input node: a node which communicates with an input device and publishes data from the input device on one or more topics
* Process node: a node which processes data acquired from one or more topics and/or from other sources. The results are published on one or more topics and/or to other sources.
* Output node: a node which communicates with an output device as result of published data on one or more topics

A node is one or more programs or scripts in C++ or Python who independently of other nodes does its task. The nodes are shown in the next figure.

image:ros_node_topic_overview.png[image]


=== Nodes

[cols=",",options="header",]
|===============================================
|Nodes|Functions
||Willy input
|Lidar_0 |Fetch  the raw data from the LIDAR and publishes the mapping data on ROS topics
|Sonar_0 |Fetch the raw data from the sonar and publishes the data on ROS topics
|Kinect_0 |Fetch the raw data from the Kinect and publishes the graphical data on ROS topics
|Microphone_0 |Fetch the raw data from the microphone and publishes the audio data on ROS topics
|Keyboard_0 |Fetch the raw data from the keyboard and publishes the pressed keys data on ROS topics

||Willy process
|Interaction_0|Social interaction and the enquetes
|Emergency_0|Emergency stop and shutdown of Willy in case of an emergency
|Drive_0|Driving of Willy

||Willy output
|Audio_controller_0|Subscribes to the audio topics and steers the speakers
|Motor_controller_0|Subscribes to the drive topics and steers the motor of the propulsion

||Skylab input
|Skylab_topic_publish_0|Fetches data from the PostgreSQL database and publishes data on ROS topics
|Skylab_app_get_status_0|Fetches JSON data from the App supplier Radeffect and publishes data on ROS topics and in the PostgreSQL database
||Skylab process

||Skylab output
|Skylab_topic_listen_0|Fetches data from ROS topics and publishes data in the PostgreSQL database
|Skylab_app_post_status_0|Fetches data from ROS topics and publishes JSON data to the App supplier Radeffect and in the PostgreSQL database
|===============================================

=== Topics
There are several communication protocols defined in ROS, but in Willy only topics are used. The topics are shown in the next table.

[cols=",,,,,",options="header",]
|===============================================
|Topic name|Purpose|Publisher|Subscriber|Message type|Message protocol
|/willy/health|Is Willy healthy or is there an issue?|All nodes|All nodes|Int32
a|
- 1 = healthy
- 2 = non-critical issue
- 3 = critical issue
|/will/health_reason|If Willy is not healthy, the reason for that is published in clear text here|All nodes|All nodes|String|Clear text
|/willy/activity|What is Willy doing?|Brain SI|All nodes|Int32
a|
- 1 = cruising
- 2 = conversation
- 3 = enquÃªte
- 4 = driving with a defined target
|/interaction/is_active|If the social interaction is busy?|Social interaction speech recognition|All nodes|Int32
a|
- 0 = not active
- 1 = active
|/interaction/clear_text|The unprocessed text what the person said|Social interaction speech recognition|All nodes|String|Who are you?
|/move_action|Move actions for willy|Navigation brain|SI|String
a|
- turn_around = Turn Willy around
|===============================================
